(function(){"use strict";BX.namespace("BX.Landing");var t=BX.Landing.Utils.deepFreeze;var e=BX.Landing.Utils.style;var n=BX.Landing.Utils.insertAfter;var i=BX.Landing.Utils.insertBefore;var s=BX.Landing.Utils.append;var a=BX.Landing.Utils.isPlainObject;var o=BX.Landing.Utils.isBoolean;var r=BX.Landing.Utils.isNumber;var c=BX.Landing.Utils.isString;var l=BX.Landing.Utils.isArray;var d=BX.Landing.Utils.isEmpty;var h=BX.Landing.Utils.addClass;var u=BX.Landing.Utils.removeClass;var g=BX.Landing.Utils.hasClass;var f=BX.Landing.Utils.create;var m=BX.Landing.Utils.debounce;var B=BX.Landing.Utils.fireCustomEvent;var p=BX.Landing.Utils.onCustomEvent;var v=BX.Landing.Utils.bind;var b=BX.Landing.Utils.unbind;var k=BX.Landing.Utils.getClass;var y=BX.Landing.Utils.rect;var L=BX.Landing.Utils.setTextContent;var C=BX.Landing.Utils.translateY;var I=BX.Landing.Utils.nextSibling;var X=BX.Landing.Utils.prevSibling;var E=BX.Landing.Utils.join;var _=BX.Landing.Utils.slice;var T=BX.Landing.Utils.decodeDataValue;var N=BX.Landing.Utils.encodeDataValue;var w=BX.Landing.Utils.data;var S=BX.Landing.Utils.removePanels;var A=BX.Landing.Utils.getCSSSelector;var O=BX.Landing.Utils.remove;var P=BX.Landing.Utils.clone;var U=BX.Landing.Utils.trim;var M=BX.Landing.Utils.prepend;var D=BX.Landing.Utils.random;var F=BX.Landing.Collection.BaseCollection;var x=BX.Landing.Collection.NodeCollection;var j=BX.Landing.UI.Collection.FormCollection;var R=BX.Landing.Collection.CardCollection;var G=BX.Landing.UI.Collection.PanelCollection;var V=BX.Landing.UI.Panel.BaseButtonPanel;var H=BX.Landing.UI.Panel.CardAction;var q=BX.Landing.UI.Panel.ContentEdit;var K=BX.Landing.UI.Button.BaseButton;var W=BX.Landing.UI.Button.Action;var z=BX.Landing.UI.Button.Plus;var Y=BX.Landing.UI.Button.CardAction;var J=BX.Landing.UI.Factory.StyleFactory;var Q=BX.Landing.UI.Form.BaseForm;var Z=BX.Landing.UI.Form.StyleForm;var $=BX.Landing.UI.Form.CardForm;var tt=BX.Landing.Group;var et=BX.Landing.Event.Block;var nt=BX.Landing.UI.Card.TabCard;var it=BX.Landing.UI.Tool.Menu;var st=BX.Landing.Backend.getInstance();var at="D";var ot="V";var rt="W";var ct="X";function lt(t){var e=BX.Landing.Main.getInstance();return e.options.style["bitrix"]["style"][t]}function dt(t){var e=BX.Landing.Main.getInstance();return t in e.options.style["bitrix"]["group"]}function ht(t){var e=BX.Landing.Main.getInstance();return e.options.style["bitrix"]["group"][t]}function ut(t){if(!!t){if(!t.loader){t.loader=new BX.Loader({target:t.layout,size:16});e(t.loader.layout.querySelector(".main-ui-loader-svg-circle"),{"stroke-width":"4px"})}t.loader.show();h(t.text,"landing-ui-hide-icon")}}function gt(t){if(!!t){if(t.loader){t.loader.hide();u(t.text,"landing-ui-hide-icon")}}}function ft(t){return!!t&&t.includes("@")}BX.Landing.Block=function(e,n){this.node=e;this.parent=e.parentElement;this.content=e.firstElementChild;this.siteId=w(e.parentElement,"data-site");this.lid=w(e.parentElement,"data-landing");this.id=r(parseInt(n.id))?parseInt(n.id):0;this.selector=E("#block",r(n.id)?n.id:0," > :first-child");this.active=o(n.active)?n.active:true;this.manifest=a(n.manifest)?n.manifest:{};this.manifest.nodes=a(n.manifest.nodes)?n.manifest.nodes:{};this.manifest.cards=a(n.manifest.cards)?n.manifest.cards:{};this.manifest.attrs=a(n.manifest.attrs)?n.manifest.attrs:{};this.onStyleInputWithDebounce=m(this.onStyleInput,1e3,this);this.changeTimeout=null;this.access=n.access;this.nodes=new x;this.cards=new R;this.panels=new G;this.groups=new F;this.changedNodes=new F;this.styles=new F;this.forms=new j;this.onEditorEnabled=this.onEditorEnabled.bind(this);this.onEditorDisabled=this.onEditorDisabled.bind(this);this.adjustPanelsPosition=this.adjustPanelsPosition.bind(this);this.onMouseMove=this.onMouseMove.bind(this);this.onStorage=this.onStorage.bind(this);this.onBlockRemove=this.onBlockRemove.bind(this);this.onBlockInit=this.onBlockInit.bind(this);t(this.manifest);this.node.classList[this.active?"remove":"add"]("landing-block-disabled");this.state="ready";this.initPanels();this.initStyles();this.adjustContextSensitivityStyles();this.disableLinks();top.BX.Landing.Block.storage.push(this);B(window,"BX.Landing.Block:init",[this.createEvent()]);p("BX.Landing.Editor:enable",this.onEditorEnabled);p("BX.Landing.Editor:disable",this.onEditorDisabled);p("BX.Landing.Block:afterRemove",this.onBlockRemove);p("BX.Landing.Block:init",this.onBlockInit);v(this.node,"mousemove",this.onMouseMove);v(this.node,"keydown",this.adjustPanelsPosition);v(top,"storage",this.onStorage)};BX.Landing.Block.storage=new BX.Landing.Collection.BlockCollection;BX.Landing.Block.prototype={onMouseMove:function(){if(this.state==="ready"){b(this.node,"mousemove",this.onMouseMove);this.initEntities();this.lazyInitPanels();this.state="complete"}},disableLinks:function(){var t='a, button, input[type="submit"], input[type="button"]';var e=_(this.content.querySelectorAll(t));e.forEach(function(t){v(t,function(t){t.preventDefault()})})},adjustContextSensitivityStyles:function(){if(g(this.parent,"landing-sidebar")){if(!g(this.content,"landing-adjusted")){var t=Object.keys(this.manifest.style.nodes);var e=t.filter(function(t){return!!this.manifest.style.nodes[t].type&&this.manifest.style.nodes[t].type.indexOf("columns")!==-1},this);if(d(e)){return}var n=lt("columns");e.forEach(function(t){var e=this.styles.get(t);if(e){e.setValue("col-lg-12",n.items)}},this);var i=this.styles.get(this.selector);if(i){i.setValue("landing-adjusted",["landing-adjusted"])}this.saveStyles()}}},forceInit:function(){this.onMouseMove()},createEvent:function(t){return new et({block:this.node,node:!!t&&!!t.node?t.node:null,card:!!t&&!!t.card?t.card:null,data:!!t&&t.data,onForceInit:this.forceInit.bind(this)})},initEntities:function(){this.initCards();this.initNodes();this.initGroups()},initGroups:function(){var t=[];var e=a(this.manifest.groups)?this.manifest.groups:{};this.nodes.forEach(function(e){if(c(e.manifest.group)&&!t.includes(e.manifest.group)){t.push(e.manifest.group)}});t.forEach(function(t){var n=this.nodes.filter(function(e){return e.manifest.group===t});this.groups.add(new tt({id:t,name:e[t],nodes:n,onClick:this.onGroupClick.bind(this)}))},this)},onGroupClick:function(t){this.showContentPanel({name:t.name,nodes:t.nodes,compact:true,nodesOnly:true})},initPanels:function(){if(!this.panels.get("create_action")){var t=new V("create_action","landing-ui-panel-create-action");t.addButton(new z("insert_after",{text:BX.message("ACTION_BUTTON_CREATE"),onClick:this.addBlockAfterThis.bind(this)}));t.show();this.addPanel(t)}},lazyInitPanels:function(){if(!this.panels.contains("content_actions")){var t=new V("content_actions","landing-ui-panel-content-action");if(a(this.manifest.nodes)){t.addButton(new W("content",{text:BX.message("ACTION_BUTTON_CONTENT"),onClick:this.onShowContentPanel.bind(this),disabled:this.access<rt,attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_EDIT")}}))}if(a(this.manifest.style)){t.addButton(new W("style",{text:BX.message("ACTION_BUTTON_STYLE"),onClick:this.onStyleShow.bind(this),disabled:this.access<ot,attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_DESIGN")}}))}var e=BX.Landing.Main.getInstance().options.placements.blocks;if(a(e)&&(this.manifest.code in e||e["*"])){var n=[];if(this.manifest.code in e){Object.keys(e[this.manifest.code]).forEach(function(t){n.push(e[this.manifest.code][t])},this)}if(e["*"]){Object.keys(e["*"]).forEach(function(t){n.push(e["*"][t])},this)}if(n.length){t.addButton(new W("actions",{html:BX.message("ACTION_BUTTON_CONTENT_MORE"),onClick:this.onPlacementButtonClick.bind(this,n)}))}h(t.buttons.get("style").layout,"landing-ui-no-rounded")}if(a(this.manifest.style)){var i=new W("block_display_info",{html:"&nbsp;"});v(i.layout,"mouseenter",this.onBlockDisplayMouseenter.bind(this));v(i.layout,"mouseleave",this.onBlockDisplayMouseleave.bind(this));t.addButton(i)}t.show();this.addPanel(t)}if(!this.panels.get("block_action")){var s=new V("block_action","landing-ui-panel-block-action");var o=this.getBlockFromRepository(this.manifest.code);if(o&&o.restricted){var r=new W("restricted",{html:"&nbsp;",className:"landing-ui-block-restricted-button",onClick:this.onRestrictedButtonClick.bind(this)});v(r.layout,"mouseenter",this.onRestrictedButtonMouseenter.bind(this));v(r.layout,"mouseleave",this.onRestrictedButtonMouseleave.bind(this));s.addButton(r)}s.addButton(new W("down",{html:BX.message("ACTION_BUTTON_DOWN"),onClick:this.moveDown.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_ACTION_SORT_DOWN")}}));s.addButton(new W("up",{html:BX.message("ACTION_BUTTON_UP"),onClick:this.moveUp.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_ACTION_SORT_UP")}}));s.addButton(new W("actions",{html:BX.message("ACTION_BUTTON_ACTIONS"),onClick:this.showBlockActionsMenu.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_ACTION_ADDITIONAL_ACTIONS")}}));s.addButton(new W("remove",{html:BX.message("ACTION_BUTTON_REMOVE"),disabled:this.access<ct,onClick:this.deleteBlock.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_ACTION_REMOVE")}}));s.show();this.addPanel(s)}this.adjustPanelsPosition();this.adjustSortButtonsState()},getBlockFromRepository:function(t){var e=BX.Landing.Main.getInstance().options.blocks;var n=Object.keys(e);var i=n.find(function(n){return t in e[n].items});if(i){return e[i].items[t]}},onRestrictedButtonClick:function(t){t.preventDefault()},onPlacementClick:function(t){BX.rest.AppLayout.openApplication(t.app_id,{ID:this.id,CODE:this.manifest.code,LID:BX.Landing.Main.getInstance().id},{PLACEMENT:"LANDING_BLOCK_"+this.manifest.code.toUpperCase(),PLACEMENT_ID:t.id});if(this.blockPlacementsActionsMenu){this.blockPlacementsActionsMenu.close()}},onPlacementButtonClick:function(t){this.panels.get("content_actions").buttons.get("actions").activate();if(!this.blockPlacementsActionsMenu){var e=this.panels.get("content_actions").buttons.get("actions");var n=E("block_",this.id,"content_placement_actions_",D());var i=t.map(function(t){return new BX.PopupMenuItem({id:"placement_"+t.id+"_"+D(),text:t.title,onclick:this.onPlacementClick.bind(this,t)})},this);this.blockPlacementsActionsMenu=new it({id:n,bindElement:e.layout,items:i,angle:{position:"top",offset:80},offsetTop:-6,events:{onPopupClose:function(){this.panels.get("content_actions").buttons.get("actions").deactivate();u(this.node,"landing-ui-hover")}.bind(this)}})}h(this.node,"landing-ui-hover");this.blockPlacementsActionsMenu.show()},onRestrictedButtonMouseenter:function(t){clearTimeout(this.displayBlockTimer);this.displayBlockTimer=setTimeout(function(t){BX.Landing.UI.Tool.Suggest.getInstance().show(t,{description:BX.message("LANDING_BLOCK_RESTRICTED_TEXT")})}.bind(this),200,t.currentTarget)},onRestrictedButtonMouseleave:function(){clearTimeout(this.displayBlockTimer);BX.Landing.UI.Tool.Suggest.getInstance().hide()},onBlockDisplayMouseenter:function(t){clearTimeout(this.displayBlockTimer);this.displayBlockTimer=setTimeout(function(t){BX.Landing.UI.Tool.Suggest.getInstance().show(t,{name:f("div",{props:{className:"landing-ui-block-display-message-header"},html:BX.message("LANDING_BLOCK_DISABLED_ON_DESKTOP_NAME")}).outerHTML,description:this.getBlockDisplayItems()})}.bind(this),300,t.currentTarget)},onBlockDisplayMouseleave:function(){clearTimeout(this.displayBlockTimer);BX.Landing.UI.Tool.Suggest.getInstance().hide()},getBlockDisplayItems:function(){function t(t){return f("div",{props:{className:"landing-ui-block-display-message"},attrs:{"data-mod":t},children:[f("div",{props:{className:"landing-ui-block-display-message-left"},html:"&nbsp;"}),f("div",{props:{className:"landing-ui-block-display-message-right"},children:[f("p",{html:BX.message("LANDING_BLOCK_HIDDEN_ON_"+(t?t.toUpperCase():""))})]})]})}var e=f("div");if(g(this.content,"l-d-lg-none")){e.appendChild(t("desktop"))}if(g(this.content,"l-d-md-none")){e.appendChild(t("tablet"))}if(g(this.content,"l-d-xs-none")){e.appendChild(t("mobile"))}return e.outerHTML},adjustPanelsPosition:function(){var t=y(this.node);if(t.height<80){h(this.panels.get("content_actions").layout,"landing-ui-panel-actions-compact");h(this.panels.get("block_action").layout,"landing-ui-panel-actions-compact")}else{u(this.panels.get("content_actions").layout,"landing-ui-panel-actions-compact");u(this.panels.get("block_action").layout,"landing-ui-panel-actions-compact")}},onEditorEnabled:function(t){if(this.node.contains(t)){h(this.node,"landing-ui-hover")}},onEditorDisabled:function(){u(this.node,"landing-ui-hover")},onStorage:function(){if(this.blockActionsMenu){var t=this.blockActionsMenu.getMenuItem("block_paste");if(t){if(window.localStorage.landingBlockId){t.layout.item.setAttribute("title",window.localStorage.landingBlockName);u(t.layout.item,"landing-ui-disabled");h(t.layout.item,"menu-popup-no-icon")}else{t.layout.item.setAttribute("title","");h(t.layout.item,"landing-ui-disabled")}}}},showBlockActionsMenu:function(){this.panels.get("block_action").buttons.get("actions").activate();if(!this.blockActionsMenu){var t=g(this.node.parentElement,"landing-sidebar");var e=this.panels.get("block_action").buttons.get("actions");var n=E("block_",this.id,"_actions_",D());var i=BX.Landing.Main.getInstance();this.blockActionsMenu=new it({id:n,bindElement:e.layout,className:"landing-ui-block-actions-popup",angle:{position:"top",offset:t?70:146},offsetTop:-6,offsetLeft:-26,events:{onPopupClose:function(){this.panels.get("block_action").buttons.get("actions").deactivate();u(this.node,"landing-ui-hover")}.bind(this)},items:[new BX.PopupMenuItem({id:"show_hide",text:BX.message(this.isEnabled()?"ACTION_BUTTON_HIDE":"ACTION_BUTTON_SHOW"),className:this.access<rt?"landing-ui-disabled":"",onclick:function(){this.onStateChange();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({text:BX.message("ACTION_BUTTON_ACTIONS_CUT"),className:this.access<ct?"landing-ui-disabled":"",onclick:function(){i.onCutBlock.bind(i,this)();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({text:BX.message("ACTION_BUTTON_ACTIONS_COPY"),onclick:function(){i.onCopyBlock.bind(i,this)();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({id:"block_paste",text:BX.message("ACTION_BUTTON_ACTIONS_PASTE"),title:window.localStorage.landingBlockName,className:window.localStorage.landingBlockId?"":"landing-ui-disabled",onclick:function(){i.onPasteBlock.bind(i,this)();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({text:BX.message("LANDING_BLOCKS_ACTIONS_FEEDBACK_BUTTON"),onclick:function(){BX.Landing.Main.getInstance().showSliderFeedbackForm({blockName:this.manifest.block.name,blockCode:this.manifest.code,blockSection:this.manifest.block.section,landingId:BX.Landing.Main.getInstance().id,target:"blockActions"});this.blockActionsMenu.close()}.bind(this)})]})}h(this.node,"landing-ui-hover");this.blockActionsMenu.show()},moveUp:function(t){var n=X(this.node,"block-wrapper");var s=this.node;if(n){var a=Promise.all([C(s,-y(n).height),C(n,y(s).height)]);a.then(function(){e(s,{transform:null,transition:null});e(n,{transform:null,transition:null});i(s,n);if(!t||typeof t==="object"){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,selector:"#block"+this.id,command:"sortBlock",undo:"moveDown",redo:"moveUp"}))}}.bind(this));st.action("Landing::upBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})}},moveDown:function(t){var i=I(this.node,"block-wrapper");var s=this.node;if(!!i){var a=Promise.all([C(s,y(i).height),C(i,-y(s).height)]);a.then(function(){e(s,{transform:null,transition:null});e(i,{transform:null,transition:null});n(s,i);if(!t||typeof t==="object"){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,selector:"#block"+this.id,command:"sortBlock",undo:"moveUp",redo:"moveDown"}))}}.bind(this));st.action("Landing::downBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})}},addPanel:function(t,e){if(!this.panels.contains(t)){this.panels.add(t);if(!e){s(t.layout,this.node)}else{i(t.layout,e)}}},onShowContentPanel:function(){this.showContentPanel();BX.Landing.UI.Panel.EditorPanel.getInstance().hide()},onStateChange:function(){if(this.isEnabled()){this.disable()}else{this.enable()}},isEnabled:function(){return this.active},enable:function(){this.active=true;u(this.node,"landing-block-disabled");L(this.blockActionsMenu.getMenuItem("show_hide").getLayout().text,BX.message("ACTION_BUTTON_HIDE"));st.action("Landing::showBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})},disable:function(){this.active=false;h(this.node,"landing-block-disabled");L(this.blockActionsMenu.getMenuItem("show_hide").getLayout().text,BX.message("ACTION_BUTTON_SHOW"));st.action("Landing::hideBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})},initCards:function(){this.forEachCard(function(t,e,n){var i=this.cards.getByNode(t);var s=this.manifest.cards[e];var a=E(e,"@",n);if(i){i.panels.get("cardAction").layout.remove();this.cards.remove(i)}i=new BX.Landing.Block.Card(t,s,a);this.cards.add(i);if(s.allowInlineEdit!==false){var o=new H("cardAction","landing-ui-panel-block-card-action");o.show();i.addPanel(o);o.addButton(new Y("clone",{html:"&nbsp;",onClick:function(t){t.stopPropagation();this.cloneCard(a)}.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_CARD_ACTION_CLONE")}}));o.addButton(new Y("remove",{html:"&nbsp;",onClick:function(t){t.stopPropagation();this.removeCard(a)}.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_CARD_ACTION_REMOVE")}}))}i.selector=a});this.cards.sort(function(t,e){return t.getIndex()>e.getIndex()})},cloneCard:function(t,e){var i=this.cards.getBySelector(t);var s=i.panels.get("cardAction").buttons.get("clone");var a={block:this.id,selector:t,lid:this.lid,siteId:this.siteId};var o={code:this.manifest.code};var r=this;ut(s);return st.action("Landing\\Block::cloneCard",a,o).then(function(){B("BX.Landing.Block:Card:beforeAdd",[r.createEvent({card:i.node})])}).then(function(){var t=BX.clone(i.node);S(t);n(t,i.node);return t}).then(function(t){gt(s);B("BX.Landing.Block:Card:add",[r.createEvent({card:t})]);r.initEntities();if(!e){var n=A(t.parentNode);var a=r.cards.getByNode(t);BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:r.id,selector:a.selector,command:"addCard",undo:{container:n,selector:a.selector},redo:{container:n,index:i.getIndex(),html:t.outerHTML}}))}}).catch(function(){gt(s);return Promise.reject()})},removeCard:function(t,e){var n=this.cards.getBySelector(t);var i=n.panels.get("cardAction").buttons.get("remove");var s={block:this.id,selector:t,lid:this.lid,siteId:this.siteId};var a={code:this.manifest.code};var o=this;ut(i);return st.action("Landing\\Block::removeCard",s,a).then(function(){B("BX.Landing.Block:Card:beforeRemove",[o.createEvent({card:n.node})]);if(!e){var t=A(n.node.parentElement);BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:o.id,selector:n.selector,command:"removeCard",undo:{container:t,index:n.getIndex(),html:n.node.outerHTML},redo:{container:t,selector:n.selector}}))}}).then(function(){o.cards.remove(n);n.node.remove();o.initEntities()}).then(function(){var e=o.createEvent({data:{selector:t}});B("BX.Landing.Block:Card:remove",[e]);gt(i)}).catch(function(){gt(i);return Promise.reject()})},addCard:function(t){var e=t.selector.split("@")[0]+(t.index>0?"@"+(t.index-1):"");var i={block:this.id,content:t.content,selector:e,lid:this.lid,siteId:this.siteId};var s={code:this.manifest.code};var a=t.container;var o=f("div",{html:t.content}).firstElementChild;var r=this;return st.action("Landing\\Block::addCard",i,s).then(function(){B("BX.Landing.Block:Card:beforeAdd",[r.createEvent({card:o})])}).then(function(){var i;if(t.index<=0){i=r.cards.find(function(t){return t.selector.includes(e.split("@")[0])});if(i){M(o,i.node.parentNode)}}else{i=r.cards.getBySelector(e.split("@")[0]+"@"+(t.index-1));if(i){n(o,i.node)}}S(a);r.initEntities();B("BX.Landing.Block:Card:add",[r.createEvent({card:o})])})},forEachCard:function(t){var e=Object.keys(this.manifest.cards);e.map(function(e){var n=_(this.node.querySelectorAll(e));n.forEach(function(n,i){t.apply(this,[n,e,i])},this)},this)},initNodes:function(){var t=[];this.forEachNodeElements(function(e,n,i){var s=this.nodes.getByNode(e);var a=E(n,"@",i);if(!s){var o=k(this.manifest.nodes[n].handler);s=new o({node:e,manifest:this.manifest.nodes[n],selector:a,onChange:this.onNodeChange.bind(this),onChangeOptions:this.onNodeOptionsChange.bind(this),onDesignShow:this.showStylePanel.bind(this),uploadParams:{action:"Block::uploadFile",block:this.id}});this.nodes.add(s)}s.selector=a;t.push(s)});this.nodes.clear();t.forEach(function(t){this.nodes.add(t)},this);this.nodes.sort(function(t,e){return t.getIndex()>e.getIndex()})},onNodeOptionsChange:function(t){if(!d(t)){var e={code:this.manifest.code};t.block=this.id;return BX.Landing.Backend.getInstance().action("Block::updateNode",t,e)}},forEachNodeElements:function(t){Object.keys(this.manifest.nodes).forEach(function(e){try{_(this.node.querySelectorAll(e)).forEach(function(n,i){t.apply(this,[n,e,i])},this)}catch(t){}},this)},showContentPanel:function(t){var e=!!t&&t.nodes?t.nodes:this.nodes;var n=!!t&&t.name?t.name:null;var i=!!t&&t.nodesOnly?t.nodesOnly:false;var a=!!t&&t.compact;var o=this.panels.get("content_edit");if(!o){o=new q("content_edit",{title:BX.message("LANDING_CONTENT_PANEL_TITLE"),subTitle:this.manifest.block.name,footer:[new K("save_block_content",{text:BX.message("BLOCK_SAVE"),onClick:this.onContentSave.bind(this),className:"landing-ui-button-content-save",attrs:{title:BX.message("LANDING_TITLE_OF_SLIDER_SAVE")}}),new K("cancel_block_content",{text:BX.message("BLOCK_CANCEL"),onClick:this.onContentCancel.bind(this),className:"landing-ui-button-content-cancel",attrs:{title:BX.message("LANDING_TITLE_OF_SLIDER_CANCEL")}})]});this.addPanel(o)}o.compact(a);o.clear();var r=this.getBlockFromRepository(this.manifest.code);if(r&&r.restricted){s(this.getRestrictedMessage(),o.content)}this.getEditForms(e,n,i).forEach(o.appendForm,o);o.show()},getRestrictedMessage:function(){return f("div",{props:{className:"ui-alert ui-alert-warning"},html:BX.message("LANDING_BLOCK_RESTRICTED_TEXT"),attrs:{style:"margin-bottom: 20px"}})},onStyleShow:function(){this.showStylePanel(this.selector);BX.Landing.UI.Panel.EditorPanel.getInstance().hide()},getPostfix:function(){return""},expandTypeGroups:function(t){var e=[];if(!BX.type.isArray(t)){t=[t]}t.forEach(function(t){if(dt(t)){ht(t).forEach(function(t){e.push(t)})}else{e.push(t)}});return e},createStyleForm:function(t,e,n){var i=this.forms.get(t);if(!i){var s=!!e.props?e.props:!!e.type?e.type:null;var a=!!e.title?e.title:!!e.name?e.name:"";if(!!s&&!!a){var o=new J({frame:window,postfix:this.getPostfix()});i=new Z({id:t,title:a,selector:t,iframe:window});s=this.expandTypeGroups(s);s.forEach(function(e){var s=lt(e);var a=this.styles.get(t);var r=o.createField({selector:!n?this.makeRelativeSelector(t):t,property:s.property,style:e,pseudoElement:s["pseudo-element"],pseudoClass:s["pseudo-class"],type:s.type,title:s.name,items:s.items,onChange:function(e,o,r,c){var l=!!s.exclude?lt(s.exclude):null;if(l){i.fields.forEach(function(t){if(t.style===s.exclude){t.reset()}})}var d={className:"",style:""};if(a.node[0]){d.className=a.node[0].className;d.style=a.node[0].style.cssText}var h=this.createEvent({data:{selector:t,value:e,items:o,postfix:r,affect:c,exclude:l}});B(window,"BX.Landing.Block:beforeApplyStyleChanges",[h]);a.setValue(e,o,r,c,l);var u={className:"",style:""};if(a.node[0]){u.className=a.node[0].className;u.style=a.node[0].style.cssText}try{if(JSON.stringify(d)!==JSON.stringify(u)){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,command:"updateStyle",selector:!n?this.makeRelativeSelector(t):t,undo:d,redo:u}))}}catch(t){}this.onStyleInputWithDebounce({node:a.node,data:a.getValue()})}.bind(this)});i.addField(r)},this);this.forms.add(i)}}i.fields.forEach(function(t){if(t.popup){t.popup.close()}});return i},initStyles:function(){this.styles.clear();var t=new BX.Landing.UI.Style({id:this.selector,iframe:window,selector:this.selector,relativeSelector:this.selector,onClick:this.onStyleClick.bind(this,this.selector)});this.styles.add(t);if(a(this.manifest.style.nodes)){Object.keys(this.manifest.style.nodes).forEach(function(t){var e=new BX.Landing.UI.Style({id:t,iframe:window,selector:t,relativeSelector:this.makeRelativeSelector(t),onClick:this.onStyleClick.bind(this,t)});this.styles.add(e)},this)}},onStyleClick:function(t){this.showStylePanel(t);var e=this.forms.get(t);if(e){BX.Landing.PageObject.getInstance().design().then(function(t){BX.Landing.UI.Panel.Content.scrollTo(t.content,null)})}},makeRelativeSelector:function(t){return E(this.selector," ",t)},makeAbsoluteSelector:function(t){t=t||this.selector;t=U(t);var e=t===this.selector?" > :first-child":this.selector;return U(t.replace(e,""))},saveStyles:function(){var t=this.styles.fetchChanges();if(t.length){t.forEach(function(t){if(t.selector===this.selector){t.selector=t.selector.replace(" > :first-child","")}},this);var e=t.fetchValues();st.action("Landing\\Block::updateStyles",{block:this.id,data:e,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})}},showStylePanel:function(t){BX.Landing.PageObject.getInstance().design().then(function(t){t.clearContent();return t.show()}).then(function(e){var n=this.isBlockSelector(t);var i=this.getStyleOptions(t);if(l(i.type)||c(i.type)){if(i.type.length){e.appendForm(this.createStyleForm(t,i,n))}}if(a(i.additional)){t=i.selector?i.selector:t;e.appendForm(this.createAdditionalForm({form:Z,selector:t,group:i.additional,onChange:this.onAttributeChange.bind(this)}));return}if(l(i.additional)){i.additional.forEach(function(n){e.appendForm(this.createAdditionalForm({form:Z,selector:t,group:n,onChange:this.onAttributeChange.bind(this)}))},this)}}.bind(this))},getStyleOptions:function(t){if(this.isBlockSelector(t)){return this.prepareBlockOptions(this.manifest.style.block)}return this.manifest.style.nodes[t]},createAdditionalForm:function(t){var e=new t.form({title:t.group.name,type:"attrs"});t.group.attrs.forEach(function(n){var i=n.selector||t.selector;var s;if(l(n.tabs)){var a=new nt({tabs:n.tabs.map(function(e){return{id:D(),name:e.name,active:e.active,fields:e.attrs.map(function(e){return this.createAttributeField(e,e.selector||t.selector,t.onChange)},this)}},this)});e.addCard(a);return}s=this.createAttributeField(n,i,t.onChange);e.addField(s)},this);return e},prepareBlockOptions:function(t){t=a(t)?t:{};t=P(t);t.name=BX.message("BLOCK_STYLE_OPTIONS");if(!a(t.type)&&!c(t.type)&&!l(t.type)){t.type=["display","padding-top","padding-bottom","padding-left","padding-right","margin-top","background-color","background-gradient"]}return t},createAttributeField:function(t,e,n){var i=this.createFieldFactory(e,n);var s=this.getElementBySelector(e);var a=P(t);if(a.value===null||a.value===undefined){a.value=""}if(s){var o=w(s,a.attribute);if(o!==null){a.value=o}}return i.create(a)},onAttributeChange:function(t){clearTimeout(this.attributeChangeTimeout);if(!this.requestData){this.requestData={}}this.appendFieldValue(t,this.requestData);if(this.containsPseudoSelector(this.requestData)&&!this.attributeChangeLoader){this.attributeChangeLoader=new BX.Loader({target:this.node,color:"rgba(255, 255, 255, .8)"});this.attributeChangeLoader.layout.style.position="fixed";this.attributeChangeLoader.layout.style.zIndex="999";this.attributeChangeLoader.show();BX.Landing.Main.getInstance().showOverlay()}this.attributeChangeTimeout=setTimeout(function(){Promise.resolve(this.requestData).then(this.applyAttributeChanges.bind(this)).then(this.saveChanges.bind(this)).then(this.reload.bind(this)).then(function(){this.requestData=null;this.attributeChangeLoader=null;BX.Landing.Main.getInstance().hideOverlay()}.bind(this))}.bind(this),800)},appendFieldValue:function(t,e){var n=this.makeAbsoluteSelector(t.selector);var i=t.getValue();try{i=N(i)}catch(e){i=t.getValue()}e[n]=e[n]||{};e[n]["attrs"]=e[n]["attrs"]||{};e[n]["attrs"][t.attribute]=i},getElementBySelector:function(t){if(this.isBlockSelector(t)){return this.content}var e;try{e=this.node.querySelector(t)}catch(t){e=null}return e},getElementsBySelector:function(t){if(this.isBlockSelector(t)){return[this.content]}var e;try{e=_(this.node.querySelectorAll(t))}catch(t){e=[]}return e},isBlockSelector:function(t){return!t||t===this.selector||"#block"+this.id===t},createFieldFactory:function(t,e){return new BX.Landing.UI.Factory.FieldFactory({selector:!this.isBlockSelector(t)?this.makeRelativeSelector(t):t,uploadParams:{action:"Block::uploadFile",block:this.id,lid:BX.Landing.Main.getInstance().id,id:BX.Landing.Main.getInstance().options.site_id},linkOptions:{siteId:BX.Landing.Main.getInstance().options.site_id,landingId:BX.Landing.Main.getInstance().id,filter:{"=TYPE":BX.Landing.Main.getInstance().options.params.type}},onValueChange:e||function(){}})},deleteBlock:function(t){var n=this.panels.get("block_action").buttons.get("remove");n.loader=n.loader||new BX.Loader({target:n.layout,size:28});n.loader.show();h(n.text,"landing-ui-hide-icon");e(n.loader.layout.querySelector(".main-ui-loader-svg-circle"),{"stroke-width":"4px"});BX.Landing.UI.Panel.EditorPanel.getInstance().hide();if(this.blockActionsMenu){BX.PopupMenu.destroy(this.blockActionsMenu.id)}window.localStorage.removeItem("landingBlockId");st.action("Landing::markDeletedBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code}).then(function(){n.loader.hide();u(n.text,"landing-ui-hide-icon");var e=this.createEvent();B("BX.Landing.Block:remove",[e]);_(this.node.querySelectorAll(".landing-ui-panel")).forEach(O);if(o(t)&&!t||!o(t)){var i=top.BX.Landing.Block.storage.getByNode(BX.findPreviousSibling(this.node,{className:"block-wrapper"}));BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,selector:"#block"+this.id,command:"removeBlock",undo:{currentBlock:i?i.id:null,lid:this.lid,code:this.manifest.code},redo:""}))}top.BX.Landing.Block.storage.remove(this);O(this.node);B("Landing.Block:onAfterDelete",[this]);B("BX.Landing.Block:afterRemove",[e])}.bind(this),function(){n.loader.hide();u(n.text,"landing-ui-hide-icon")})},addBlockAfterThis:function(){BX.Landing.Main.getInstance().showBlocksPanel(this)},onNodeChange:function(t){var e=this.createEvent({node:t.node});B("BX.Landing.Block:Node:update",[e]);if(!t.isSavePrevented()){clearTimeout(this.changeTimeout);this.changedNodes.add(t);this.changeTimeout=setTimeout(function(){st.action("Landing\\Block::updateNodes",{block:this.id,data:this.changedNodes.fetchValues(),lid:this.lid,siteId:this.siteId},{code:this.manifest.code});this.changedNodes.clear()}.bind(this),100)}},containsPseudoSelector:function(t){return Object.keys(t).some(function(t){var e;try{if(t!=="#block"+this.id&&t!==""){e=!this.node.querySelector(t)}else{e=false}}catch(n){e=!ft(t)}return e},this)},applyContentChanges:function(t){if(!a(t)){return Promise.reject(new TypeError("BX.Landing.Block.applyContentChanges: data isn't object"))}var e=P(t);Object.keys(e).forEach(function(t){if(!ft(t)){delete e[t]}});if(!d(e)){var n=this.createEvent({data:e});B(window,"BX.Landing.Block:beforeApplyContentChanges",[n])}Object.keys(t).forEach(function(e){if(ft(e)){var n=this.nodes.getBySelector(e);n.setValue(t[e],true);t[e]=n.getValue()}},this);return Promise.resolve(t)},applyAttributeChanges:function(t){if(!a(t)){return Promise.reject(new TypeError("BX.Landing.Block.applyAttributeChanges: requestData isn't object"))}var e=P(t);Object.keys(t).forEach(function(n){if(!(a(t[n])&&"attrs"in t[n])){delete e[n]}});if(!d(e)){var n=this.createEvent({data:e});B(window,"BX.Landing.Block:beforeApplyAttributesChanges",[n])}var i=this;Object.keys(t).forEach(function(e){if(a(t[e])&&"attrs"in t[e]){var n=i.getElementsBySelector(e);Object.keys(t[e].attrs).forEach(function(s){n.forEach(function(n){var a=T(t[e]["attrs"][s]);w(n,s,a);B("BX.Landing.Block:Node:updateAttr",[i.createEvent({node:n,requestData:a})])})})}});return Promise.resolve(t)},saveChanges:function(t){if(!a(t)){return Promise.reject(new TypeError("BX.Landing.Block.saveChanges: data isn't object"))}if(Object.keys(t).length){var e={block:this.id,data:t,lid:this.lid,siteId:this.siteId};var n={code:this.manifest.code};return st.action("Landing\\Block::updateNodes",e,n).then(function(){return Promise.resolve(t)})}else{return Promise.resolve(t)}},fetchRequestData:function(t){var e=new j;var n=new j;var i={};t.forms.forEach(function(t){(t.type==="attrs"?n:e).add(t)});e.fetchFields().fetchChanges().forEach(function(t){i[t.selector]=t.getValue()},this);n.fetchFields().fetchChanges().forEach(function(t){var e=this.makeAbsoluteSelector(t.selector);var n=t.getValue();try{n=N(n)}catch(e){n=t.getValue()}i[e]=i[e]||{};i[e]["attrs"]=i[e]["attrs"]||{};i[e]["attrs"][t.attribute]=n},this);return Promise.resolve(i)},reload:function(t){if(!this.containsPseudoSelector(t)){return Promise.resolve(t)}var e=this;return BX.Landing.Backend.getInstance().action("Block::getContent",{block:this.id,lid:this.lid,siteId:this.siteId,editMode:1}).then(function(t){BX.Landing.Main.getInstance().currentBlock=e;BX.Landing.Main.getInstance().currentArea=e.parent;return BX.Landing.Main.getInstance().addBlock(t,true,true)}).then(function(n){e.node=n;return Promise.resolve(t)})},onContentSave:function(){var t=this.panels.get("content_edit");if(t){t.hide();this.fetchRequestData(t).then(this.applyContentChanges.bind(this)).then(this.applyAttributeChanges.bind(this)).then(this.saveChanges.bind(this)).then(this.reload.bind(this)).catch(console.warn);var e=new j;t.forms.forEach(function(t){if(t.type!=="attrs"){e.add(t)}});var n={};e.fetchFields().forEach(function(t){if(t.tag){n[t.selector]={tagName:t.tag}}},this);this.onNodeOptionsChange(n)}},onContentCancel:function(){this.panels.get("content_edit").hide()},getCardsSelector:function(){var t=Object.keys(this.manifest.cards);var e=E(t.join(","),", ");var n=E(t.join(" *,")," *");return E(e,n)},onStyleInput:function(t){this.saveStyles();var e=this.createEvent(t);B("BX.Landing.Block:updateStyle",[e])},getEditForms:function(t,e,n){var i=new j;var s=Object.keys(this.manifest.nodes);var a=new x;var o=t;if(this.cards.length){o=t.notMatches(this.getCardsSelector())}s.forEach(function(t){o.matches(t).forEach(function(t){a.push(t)})},this);if(a.length){var r=new Q({title:e||BX.message("BLOCK_HEADER")});a.forEach(function(t){r.addField(t.getField())});i.add(r)}var d=Object.keys(this.manifest.attrs);if(d.length&&!n){var h=new Q({id:"attr",type:"attrs",title:BX.message("BLOCK_SETTINGS")});i.add(h);d.forEach(function(t){var e=this.manifest.attrs[t];if(!e.hidden){e=!l(e)?[e]:e;e.forEach(function(e){if(c(e.type)){h.addField(this.createAttributeField(e,t));return}if(c(e.name)&&e.attrs){i.add(this.createAdditionalForm({form:Q,selector:t,group:e,onChange:function(){}}))}},this)}},this);if(h.fields.length===0){i.remove(h)}}this.cards.forEach(function(e){var n=new $({title:e.getName()});var a=new x;var o=t.filter(function(t){return e.node.contains(t.node)});if(o.length){s.forEach(function(t){var e=o.matches(t);e.forEach(a.add,a)},this);a.forEach(function(t){n.addField(t.getField())});i.add(n)}},this);return i},isLastBlockInArea:function(){return this.parent.querySelectorAll(".block-wrapper").length<2},onBlockRemove:function(){this.adjustSortButtonsState()},onBlockInit:function(){this.adjustSortButtonsState()},adjustSortButtonsState:function(){var t=this.panels.get("block_action");if(t){if(this.isLastBlockInArea()){t.buttons.get("up").disable();t.buttons.get("down").disable()}else{t.buttons.get("up").enable();t.buttons.get("down").enable()}}}}})();